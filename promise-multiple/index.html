<!doctype html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width">
  <title>Document</title>
  <link href="../common.css" rel="stylesheet">
  <link href="../dialog.css" rel="stylesheet">
</head>
<body>
  <div id="js-contents">
    <button id="js-show-dialog" class="text-button">削除確認ダイアログを開く</button>
  </div>
  <dialog id="js-dialog" class="dialog">
    <div id="js-dialog-inner" class="dialog__inner">
      <p class="dialog__title">設定を削除しますか？</p>
      <p class="dialog__text">スタイル確認用のダイアログのため、削除を実行してもなにも起こりません。確認ができたらいずれかのボタンをクリックしてダイアログをとじてください。</p>
      <div class="dialog__buttons">
        <button id="js-dialog-cancel" class="button button--secondary button--width-full">キャンセル</button>
        <button id="js-dialog-accept" class="button button--tertiary button--width-full">削除</button>
      </div>
    </div>

    <div id="js-overlay" class="overlay">
     <span class="overlay-spinner"></span>
    </div>
  </dialog>

  <dialog id="js-error-dialog" class="dialog">
    <div class="dialog__inner">
      <p class="dialog__title">エラーが発生しました。</p>
      <p class="dialog__text message"></p>
      <div class="dialog__buttons">
        <button class="button button--secondary button--width-full">閉じる</button>
      </div>
    </div>
  </dialog>

  <script>
    const wrapper = document.getElementById("js-contents");
    const showButton = document.getElementById('js-show-dialog');
    const dialogElement = document.querySelector('#js-dialog');
    showButton.addEventListener('click', () => {
      dialogElement.showModal();
    });

    const inner = dialogElement.querySelector("#js-dialog-inner");
    const closeButton = dialogElement.querySelector('#js-dialog-cancel');
    const acceptButton = dialogElement.querySelector('#js-dialog-accept');
    const overlay = dialogElement.querySelector('#js-overlay')

    const RETURN_VALUE_CANCEL = "cancel";
    const RETURN_VALUE_ACCEPT = "accept";

    closeButton.addEventListener('click', () => {
      dialogElement.close(RETURN_VALUE_CANCEL);
    });

    const deleteAction = async () => {
      await new Promise(resolve => setTimeout(resolve, 1500));
      const result = await apiClient();

      console.log(result);

      if(!result) {
        return;
      }

      return true;
    }

    acceptButton.addEventListener('click', async () => {
      inner.inert = true;
      overlay.classList.add("active");
      console.log("1")
      const result = await deleteAction();
      console.log("2")
      inner.inert = false;
      overlay.classList.remove("active");

      if(!result) {
        return;
      }

      dialogElement.close(RETURN_VALUE_ACCEPT);
    });

    const apiClient = async (url, options) => {
      try {
        // const res = await fetch(url, options);
        // return await res.json();
        throw new Error(`API error: `);

      } catch (err) {
        document.dispatchEvent(new CustomEvent("apiError", { detail: err.message }));
        
        return null;
      }
    }

    const errorDialog = document.querySelector("#js-error-dialog");
    const errorAccept = errorDialog.querySelector("button");
    const errorMessage = errorDialog.querySelector(".message")

    document.addEventListener("apiError", (event) => {
      errorMessage.textContent = event.detail;
      errorDialog.showModal();
    });

    errorAccept.addEventListener("click", () => {
      errorDialog.close();
    })
  </script>
</body>
</html>
